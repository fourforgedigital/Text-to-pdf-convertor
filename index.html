<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Text → PDF (FourForge Digital) Animated Background</title>
  <style>
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    body { font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial; display: flex; flex-direction: column; align-items: center; padding: 24px; background: linear-gradient(-45deg, #6a11cb, #2575fc, #6a11cb, #2575fc); background-size: 400% 400%; animation: gradientShift 15s ease infinite; margin: 0; min-height: 100vh; overflow-x: hidden; }
    header { max-width: 900px; width: 100%; display: flex; align-items: center; gap: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); z-index:1; }
    header img { height: 60px; width: auto; border-radius: 8px; user-select: none; }
    header h1 { font-size: 24px; font-weight: 600; margin: 0; font-family: monospace, monospace; }
    .blinking-cursor { display:inline-block; width:1px; background:black; margin-left:3px; animation: blink 1s step-start infinite; height:28px; vertical-align:bottom; position:relative; top:2px; }
    main { width:100%; max-width:900px; background:rgba(255,255,255,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.06); z-index:1; display:flex; flex-direction:column; }
    textarea { width:100%; height:360px; font-family:monospace; padding:12px; border-radius:8px; border:1px solid #e5e7eb; resize:vertical; box-sizing:border-box; }
    input[type=text], select { width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:12px; font-size:13px; box-sizing:border-box; }
    .row { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-size:14px; z-index:1; transition:background-color .3s; }
    .btn-blue{ background:#2563eb; color:white; } .btn-green{ background:#16a34a; color:white; } .btn-gray{ background:#e5e7eb; }
    .status { margin-top:12px; color:#374151; }
    footer { margin-top:28px; text-align:center; font-size:12px; color:#6b7280; padding-top:12px; border-top:1px solid #e5e7eb; max-width:900px; width:100%; z-index:1; }
    .FFD{ text-decoration:none; color:#250b0bce; font-weight:600; }
    @media (max-width:900px){ body{padding:12px} header{padding:15px; flex-direction:column; align-items:flex-start} header img{height:50px} header h1{font-size:20px} main{padding:15px} textarea{height:280px} button{font-size:13px; padding:8px 12px; flex:1 1 45%} }
    @media (max-width:480px){ header{align-items:center;text-align:center} header img{height:40px} header h1{font-size:18px} main{padding:10px} textarea{height:220px} button{flex:1 1 100%} .row{justify-content:center} }
  </style>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="background-flash"></div>

  <header>
    <a href="https://fourforgedigital.github.io/fourforgedigital/" target="_blank"><img src="FourForage.jpg" alt="Company Logo" class="company-logo" /></a>
    <h1>FourForge Digital<span class="blinking-cursor"></span></h1>
  </header>

  <main>
    <label for="fname">Filename (end with .pdf)</label>
    <input id="fname" type="text" placeholder="my-document.pdf" value="document.pdf">

    <label for="fontSelect" style="margin-top:10px;">Choose PDF font (or upload your own)</label>
    <select id="fontSelect">
      <option value="times">Times New Roman (default)</option>
      <option value="helvetica">Helvetica</option>
      <option value="arial">Arial</option>
      <option value="courier">Courier New</option>
      <option value="georgia">Georgia</option>
      <option value="verdana">Verdana</option>
      <option value="roboto">Roboto (web)</option>
      <option value="opensans">Open Sans (web)</option>
      <option value="lato">Lato (web)</option>
      <option value="notoDeva">Noto Sans Devanagari (for Hindi)</option>
      <option value="custom">Upload custom TTF/OTF</option>
    </select>

    <input id="fontFile" type="file" accept=".ttf,.otf" style="margin-top:8px; display:none;" />

    <label for="txt" style="margin-top: 10px;">Text</label>
    <textarea id="txt" placeholder="Paste your text here..."></textarea>

    <div class="row">
      <button id="download" class="btn-blue">Download PDF</button>
      <button id="clear" class="btn-gray">Clear</button>
      <button id="copy" class="btn-gray">Copy Text</button>
      <button id="preview" class="btn-green">Preview Canvas (dev)</button>
    </div>

    <div class="status" id="status">Idle — ready.</div>
  </main>

  <footer><a href="https://fourforgedigital.github.io/fourforgedigital/" target="_blank" class="FFD">Designed & Developed by <span class="FFD">FourForge Digital</span></a></footer>

<script>
(async function(){
  const { jsPDF } = window.jspdf;
  const txt = document.getElementById('txt');
  const fname = document.getElementById('fname');
  const status = document.getElementById('status');
  const flash = document.getElementById('background-flash');
  const fontSelect = document.getElementById('fontSelect');
  const fontFile = document.getElementById('fontFile');
  const previewBtn = document.getElementById('preview');

  try { txt.value = localStorage.getItem('text_to_pdf') || ''; } catch(e){}
  function saveLocal(){ try{ localStorage.setItem('text_to_pdf', txt.value); }catch(e){} }
  function triggerFlash(){ if (flash.classList.contains('active')){ flash.classList.remove('active'); void flash.offsetWidth; flash.classList.add('active'); } else { flash.classList.add('active'); } }

  function hasHindi(text){ const hindiRegex = /[\u0900-\u097F]/; return hindiRegex.test(text); }
  function hasEmoji(text){ const emojiRegex = /[\u231A-\u231B\u23E9-\u23EC\u23F0\u23F3\u25FD-\u25FE\u2600-\u27BF\u1F000-\u1F6FF\u1F300-\u1F5FF\u1F900-\u1F9FF\u1FA70-\u1FAFF]/u; return emojiRegex.test(text); }

  // Preload common web fonts via Google Fonts (for canvas rendering).
  function loadWebFont(name){
    const map = {
      roboto: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap',
      opensans: 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400&display=swap',
      lato: 'https://fonts.googleapis.com/css2?family=Lato:wght@400&display=swap'
    };
    if (map[name]){
      const l = document.createElement('link'); l.rel='stylesheet'; l.href=map[name]; document.head.appendChild(l);
    }
  }

  async function fetchFontBuffer(url){ const r = await fetch(url); return await r.arrayBuffer(); }
  async function loadNotoDeva(){
    try{
      const buf = await fetchFontBuffer('https://cdn.jsdelivr.net/gh/googlefonts/noto-fonts@main/hinted/ttf/NotoSansDevanagari/NotoSansDevanagari-Regular.ttf');
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      return { buf, base64, name: 'NotoSansDevanagari' };
    }catch(e){ console.warn('Could not load Noto Devanagari', e); return null; }
  }
  const notoDeva = await loadNotoDeva();

  // Custom font upload
  let customFont = null; // { name, base64, buf }
  fontSelect.addEventListener('change', ()=>{
    if (fontSelect.value === 'custom'){ fontFile.style.display='block'; } else { fontFile.style.display='none'; if (['roboto','opensans','lato'].includes(fontSelect.value)) loadWebFont(fontSelect.value); }
  });

  fontFile.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if (!f) return;
    const buf = await f.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const name = 'CustomFont_' + Date.now();
    customFont = { name, base64, buf };
    status.textContent = 'Custom font loaded: ' + f.name;
  });

  function renderTextToCanvas(allText, options={widthPt:595.28, marginPt:40, fontPt:12, fontFamily:'Times New Roman'}){
    const scale = 2;
    const ptToPx = (pt)=> Math.round(pt * (scale));
    const pageWidthPx = ptToPx(options.widthPt);
    const marginPx = ptToPx(options.marginPt);
    const contentWidth = pageWidthPx - marginPx*2;
    const lineHeight = Math.round(options.fontPt * 1.35 * scale);

    const measureCanvas = document.createElement('canvas');
    const mctx = measureCanvas.getContext('2d');
    mctx.font = `${options.fontPt * scale}px ${options.fontFamily}`;

    const paragraphs = allText.replace(/\r/g,'').split('\n');
    const lines = [];
    for(const p of paragraphs){
      const words = p.split(/(\s+)/);
      let line = '';
      for(const w of words){
        const test = line + w;
        const wWidth = mctx.measureText(test).width;
        if (wWidth > contentWidth && line){ lines.push(line); line = w.trim(); }
        else { line = test; }
      }
      lines.push(line);
    }

    const totalHeight = lines.length * lineHeight + marginPx*2;
    const canvas = document.createElement('canvas');
    canvas.width = pageWidthPx;
    canvas.height = totalHeight;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.font = `${options.fontPt * scale}px ${options.fontFamily}`;
    ctx.textBaseline = 'top'; ctx.fillStyle = '#000000';

    let y = marginPx;
    for(const lineText of lines){ ctx.fillText(lineText, marginPx, y); y += lineHeight; }

    return { canvas, pageHeightPx: ptToPx(841.89), pageWidthPx, scale };
  }

  function addCanvasToPdfAsPages(doc, canvasObj, options={marginPt:40}){
    const { canvas, pageHeightPx } = canvasObj;
    let remainingHeight = canvas.height;
    let srcY = 0;
    const pxToPt = (px)=> px / (canvasObj.scale);
    const pdfPageHeightPt = 841.89; const pdfPageWidthPt = 595.28;

    while (remainingHeight > 0){
      const sliceHeightPx = Math.min(canvasObj.pageHeightPx, remainingHeight);
      const sliceCanvas = document.createElement('canvas');
      sliceCanvas.width = canvas.width; sliceCanvas.height = sliceHeightPx;
      const sctx = sliceCanvas.getContext('2d');
      sctx.drawImage(canvas, 0, srcY, canvas.width, sliceHeightPx, 0, 0, canvas.width, sliceHeightPx);
      const imgData = sliceCanvas.toDataURL('image/png');

      const x = options.marginPt; const y = options.marginPt; const w = pdfPageWidthPt - options.marginPt*2; const h = pxToPt(sliceHeightPx);
      doc.addImage(imgData, 'PNG', x, y, w, h);

      remainingHeight -= sliceHeightPx; srcY += sliceHeightPx;
      if (remainingHeight > 0) doc.addPage();
    }
  }

  function registerFontWithJsPDF(doc, internalName, base64){
    try{ doc.addFileToVFS(internalName + '.ttf', base64); doc.addFont(internalName + '.ttf', internalName, 'normal'); return true; }catch(e){ console.warn('Failed to register font with jsPDF', e); return false; }
  }
  async function registerFontWithBrowser(name, buf){
    try{ const fontFace = new FontFace(name, buf); await fontFace.load(); document.fonts.add(fontFace); return true; }catch(e){ console.warn('FontFace registration failed', e); return false; }
  }

  function makeDoc(){
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageWidth = doc.internal.pageSize.getWidth(); const pageHeight = doc.internal.pageSize.getHeight(); const margin = 40;
    const userChoice = 'auto'; const textVal = txt.value || '';
    const forceImage = userChoice === 'image';
    const containsHindi = hasHindi(textVal); const containsEmoji = hasEmoji(textVal);

    let chosenFont = fontSelect.value;

    if (chosenFont === 'roboto' || chosenFont === 'opensans' || chosenFont === 'lato') loadWebFont(chosenFont);

    if (chosenFont === 'notoDeva' && notoDeva){ registerFontWithJsPDF(doc, 'NotoSansDevanagari', notoDeva.base64); try{ registerFontWithBrowser('NotoSansDevanagari', notoDeva.buf); }catch(e){} doc.setFont('NotoSansDevanagari'); }

    if (chosenFont === 'custom' && customFont){ registerFontWithJsPDF(doc, customFont.name, customFont.base64); try{ registerFontWithBrowser(customFont.name, customFont.buf); }catch(e){} doc.setFont(customFont.name); }

    // decide canvas vs text rendering
    if (forceImage || containsEmoji || chosenFont==='custom' || ['arial','georgia','verdana'].includes(chosenFont) || (containsHindi && chosenFont!=='notoDeva' && userChoice!=='latin')){
      let canvasFontFamily = 'Times New Roman';
      if (chosenFont === 'notoDeva' && notoDeva) canvasFontFamily = 'NotoSansDevanagari';
      else if (chosenFont === 'roboto') canvasFontFamily = 'Roboto, \"Times New Roman\"';
      else if (chosenFont === 'opensans') canvasFontFamily = '\"Open Sans\", \"Times New Roman\"';
      else if (chosenFont === 'lato') canvasFontFamily = 'Lato, \"Times New Roman\"';
      else if (chosenFont === 'arial') canvasFontFamily = 'Arial, \"Times New Roman\"';
      else if (chosenFont === 'courier') canvasFontFamily = 'Courier New, \"Times New Roman\"';
      else if (chosenFont === 'georgia') canvasFontFamily = 'Georgia, \"Times New Roman\"';
      else if (chosenFont === 'verdana') canvasFontFamily = 'Verdana, \"Times New Roman\"';
      else if (chosenFont === 'custom' && customFont) canvasFontFamily = customFont.name + ', \"Times New Roman\"';

      const canvasObj = renderTextToCanvas(textVal, { widthPt: pageWidth, marginPt: margin, fontPt: 12, fontFamily: canvasFontFamily });
      addCanvasToPdfAsPages(doc, canvasObj, { marginPt: margin });
    } else {
      if (chosenFont === 'times') doc.setFont('times');
      else if (chosenFont === 'helvetica') doc.setFont('helvetica');
      else if (chosenFont === 'courier') doc.setFont('courier');
      else if (chosenFont === 'notoDeva' && notoDeva) doc.setFont('NotoSansDevanagari');
      else if (chosenFont === 'custom' && customFont) doc.setFont(customFont.name);
      // note: jsPDF doesn't include web fonts like Roboto/Open Sans by default - use canvas for those

      doc.setFontSize(12);
      const maxLineWidth = pageWidth - margin*2; const lines = doc.splitTextToSize(textVal || ' ', maxLineWidth);
      let y = margin; const lineHeight = 14;
      for(let i=0;i<lines.length;i++){
        if (y + lineHeight > pageHeight - margin){ doc.addPage(); y = margin; }
        doc.text(lines[i], margin, y);
        y += lineHeight;
      }
    }
    return doc;
  }

  document.getElementById('download').onclick = () => {
    triggerFlash();
    if (!txt.value.trim()){ status.textContent = 'Paste some text first'; return; }
    try{ status.textContent = 'Generating...'; const doc = makeDoc(); doc.save(fname.value || 'document.pdf'); status.textContent = 'Downloaded'; saveLocal(); }catch(err){ console.error(err); status.textContent = 'Error: ' + (err && err.message ? err.message : String(err)); }
  };

  document.getElementById('clear').onclick = () => { triggerFlash(); txt.value=''; saveLocal(); status.textContent='Cleared.'; };
  document.getElementById('copy').onclick = async () => { triggerFlash(); try{ await navigator.clipboard.writeText(txt.value); status.textContent='Copied'; }catch(e){ status.textContent='Copy failed'; } };

  txt.addEventListener('input', ()=>{ status.textContent='Edited (auto-saved)'; saveLocal(); });

  previewBtn.onclick = ()=>{
    const textVal = txt.value || '';
    const chosenFont = fontSelect.value;
    let canvasFontFamily = 'Times New Roman';
    if (chosenFont === 'notoDeva' && notoDeva) canvasFontFamily = 'NotoSansDevanagari';
    else if (chosenFont === 'roboto') canvasFontFamily = 'Roboto, \"Times New Roman\"';
    else if (chosenFont === 'opensans') canvasFontFamily = '\"Open Sans\", \"Times New Roman\"';
    else if (chosenFont === 'lato') canvasFontFamily = 'Lato, \"Times New Roman\"';
    else if (chosenFont === 'arial') canvasFontFamily = 'Arial, \"Times New Roman\"';
    else if (chosenFont === 'courier') canvasFontFamily = 'Courier New, \"Times New Roman\"';
    else if (chosenFont === 'georgia') canvasFontFamily = 'Georgia, \"Times New Roman\"';
    else if (chosenFont === 'verdana') canvasFontFamily = 'Verdana, \"Times New Roman\"';
    else if (chosenFont === 'custom' && customFont) canvasFontFamily = customFont.name + ', \"Times New Roman\"';

    const canvasObj = renderTextToCanvas(textVal, { widthPt: 595.28, marginPt: 40, fontPt: 12, fontFamily: canvasFontFamily });
    const data = canvasObj.canvas.toDataURL('image/png');
    const w = window.open('about:blank');
    w.document.write('<img src=\"'+data+'\" style=\"max-width:100%\"/>');
  };

})();
</script>
</body>
</html>
